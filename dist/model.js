'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Model = undefined;

var _bluebird = require('bluebird');

var Promise = _interopRequireWildcard(_bluebird);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

const $store = Symbol('$store');
const $guild = Symbol('$guild');
const $self = Symbol('$self');
const $unsubscribe = Symbol('$unsubscribe');

// TODO: figure out where error events originate (storage or model)
// and who keeps a roll-backable delta

class Model {
  constructor(opts = {}, guild) {
    this[$store] = {};
    this.$$copyValuesFrom(opts);
    if (guild) {
      this.connectToGuild(guild);
    }
  }

  $$connectToGuild(guild) {
    this[$guild] = guild;
    this[$unsubscribe] = guild.subscribe(this.constructor.$name, this.$id, v => {
      this.$$copyValuesFrom(v);
    });
  }

  get $name() {
    return this.constructor.$name;
  }

  get $id() {
    return this[$store][this.constructor.$id];
  }

  $$copyValuesFrom(opts = {}) {
    Object.keys(this.constructor.$fields).forEach(fieldName => {
      if (opts[fieldName] !== undefined) {
        // copy from opts to the best of our ability
        if (this.constructor.$fields[fieldName].type === 'array' || this.constructor.$fields[fieldName].type === 'hasMany') {
          this[$store][fieldName] = opts[fieldName].concat();
        } else if (this.constructor.$fields[fieldName].type === 'object') {
          this[$store][fieldName] = Object.assign({}, opts[fieldName]);
        } else {
          this[$store][fieldName] = opts[fieldName];
        }
      }
    });
  }

  $get(key) {
    if (this[$store][key] !== undefined) {
      return Promise.resolve(this[$store][key]);
    } else {
      return this[$guild].get(this.constructor, this.$id).then(v => {
        this.$$copyValuesFrom(v);
        return this[$store][key];
      });
    }
  }

  $load(opts = {}) {
    const options = Object.assign({}, { self: true }, opts);
    if (options.self) {
      this.getSelf().then(data => {
        this.$$copyValuesFrom(data);
      });
    }
  }

  $save() {
    return this.$set();
  }

  $set(update = this[$store]) {
    this.$$copyValuesFrom(update); // this is the optimistic update;
    let setupPromise = Promise.resolve(update);
    let skipTerminal = null;
    if (this.$id === undefined && update[this.constructor.$id] === undefined) {
      // need to get an ID.
      const terminals = this.constructor.$storage.filter(s => s.terminal);
      if (terminals.length === 1) {
        skipTerminal = terminals[0];
        setupPromise = terminals[0].write(this.constructor, update);
      } else {
        return Promise.reject(new Error('Model can only have one terminal store'));
      }
    }
    return setupPromise.then(toUpdate => {
      return Promise.all(this.constructor.$storage.map(storage => {
        if (storage !== skipTerminal) {
          return storage.write(this.constructor, toUpdate);
        } else {
          return toUpdate;
        }
      }));
    }).then(updates => updates[0]);
  }

  $add(key, item) {
    if (this.constructor.$fields[key].type === 'hasMany') {
      let id = 0;
      if (typeof item === 'number') {
        id = item;
      } else {
        id = item.$id;
      }
      if (typeof id === 'number' && id > 1) {
        return Promise.all(this.constructor.$storage.map(storage => {
          return storage.add(this.constructor, this.$id, key, item);
        }));
      } else {
        return Promise.reject(new Error('Invalid item added to hasMany'));
      }
    } else {
      return Promise.reject(new Error('Cannot $add except to hasMany field'));
    }
  }

  $remove(key, item) {
    if (this.constructor.$fields[key].type === 'hasMany') {
      let id = 0;
      if (typeof item === 'number') {
        id = item;
      } else {
        id = item.$id;
      }
      if (typeof id === 'number' && id > 1) {
        return Promise.all(this.constructor.$storage.map(storage => {
          return storage.remove(this.constructor, this.$id, key, item);
        }));
      } else {
        return Promise.reject(new Error('Invalid item $removed from hasMany'));
      }
    } else {
      return Promise.reject(new Error('Cannot $remove except from hasMany field'));
    }
  }

  $has(key) {
    if (this.constructor.$fields[key].type === 'hasMany') {
      return this[$guild].has(this.constructor, this.$id, key);
    } else {
      return Promise.reject(new Error('Cannot $has only valid on hasMany field'));
    }
  }

  $teardown() {
    this[$unsubscribe].unsubscribe();
  }

}

exports.Model = Model;
Model.$id = 'id';
Model.$name = 'Base';
Model.$self = $self;
Model.$fields = {
  id: {
    type: 'number'
  }
};
//# sourceMappingURL=data:application/json;base64,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QUF0QyxFQUEwQztBQUN4QyxlQUFPLFFBQVEsR0FBUixDQUFZLEtBQUssV0FBTCxDQUFpQixRQUFqQixDQUEwQixHQUExQixDQUErQixPQUFELElBQWE7QUFDNUQsaUJBQU8sUUFBUSxNQUFSLENBQWUsS0FBSyxXQUFwQixFQUFpQyxLQUFLLEdBQXRDLEVBQTJDLEdBQTNDLEVBQWdELElBQWhELENBQVA7QUFDRCxTQUZrQixDQUFaLENBQVA7QUFHRCxPQUpELE1BSU87QUFDTCxlQUFPLFFBQVEsTUFBUixDQUFlLElBQUksS0FBSixDQUFVLG9DQUFWLENBQWYsQ0FBUDtBQUNEO0FBQ0YsS0FkRCxNQWNPO0FBQ0wsYUFBTyxRQUFRLE1BQVIsQ0FBZSxJQUFJLEtBQUosQ0FBVSwwQ0FBVixDQUFmLENBQVA7QUFDRDtBQUNGOztBQUVELE9BQUssR0FBTCxFQUFVO0FBQ1IsUUFBSSxLQUFLLFdBQUwsQ0FBaUIsT0FBakIsQ0FBeUIsR0FBekIsRUFBOEIsSUFBOUIsS0FBdUMsU0FBM0MsRUFBc0Q7QUFDcEQsYUFBTyxLQUFLLE1BQUwsRUFBYSxHQUFiLENBQWlCLEtBQUssV0FBdEIsRUFBbUMsS0FBSyxHQUF4QyxFQUE2QyxHQUE3QyxDQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBTyxRQUFRLE1BQVIsQ0FBZSxJQUFJLEtBQUosQ0FBVSx5Q0FBVixDQUFmLENBQVA7QUFDRDtBQUNGOztBQUVELGNBQVk7QUFDVixTQUFLLFlBQUwsRUFBbUIsV0FBbkI7QUFDRDs7QUEvSWdCOztRQUFOLEssR0FBQSxLO0FBbUpiLE1BQU0sR0FBTixHQUFZLElBQVo7QUFDQSxNQUFNLEtBQU4sR0FBYyxNQUFkO0FBQ0EsTUFBTSxLQUFOLEdBQWMsS0FBZDtBQUNBLE1BQU0sT0FBTixHQUFnQjtBQUNkLE1BQUk7QUFDRixVQUFNO0FBREo7QUFEVSxDQUFoQiIsImZpbGUiOiJtb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuY29uc3QgJHN0b3JlID0gU3ltYm9sKCckc3RvcmUnKTtcbmNvbnN0ICRndWlsZCA9IFN5bWJvbCgnJGd1aWxkJyk7XG5jb25zdCAkc2VsZiA9IFN5bWJvbCgnJHNlbGYnKTtcbmNvbnN0ICR1bnN1YnNjcmliZSA9IFN5bWJvbCgnJHVuc3Vic2NyaWJlJyk7XG5cbi8vIFRPRE86IGZpZ3VyZSBvdXQgd2hlcmUgZXJyb3IgZXZlbnRzIG9yaWdpbmF0ZSAoc3RvcmFnZSBvciBtb2RlbClcbi8vIGFuZCB3aG8ga2VlcHMgYSByb2xsLWJhY2thYmxlIGRlbHRhXG5cbmV4cG9ydCBjbGFzcyBNb2RlbCB7XG4gIGNvbnN0cnVjdG9yKG9wdHMgPSB7fSwgZ3VpbGQpIHtcbiAgICB0aGlzWyRzdG9yZV0gPSB7fTtcbiAgICB0aGlzLiQkY29weVZhbHVlc0Zyb20ob3B0cyk7XG4gICAgaWYgKGd1aWxkKSB7XG4gICAgICB0aGlzLmNvbm5lY3RUb0d1aWxkKGd1aWxkKTtcbiAgICB9XG4gIH1cblxuICAkJGNvbm5lY3RUb0d1aWxkKGd1aWxkKSB7XG4gICAgdGhpc1skZ3VpbGRdID0gZ3VpbGQ7XG4gICAgdGhpc1skdW5zdWJzY3JpYmVdID0gZ3VpbGQuc3Vic2NyaWJlKHRoaXMuY29uc3RydWN0b3IuJG5hbWUsIHRoaXMuJGlkLCAodikgPT4ge1xuICAgICAgdGhpcy4kJGNvcHlWYWx1ZXNGcm9tKHYpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0ICRuYW1lKCkge1xuICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLiRuYW1lO1xuICB9XG5cbiAgZ2V0ICRpZCgpIHtcbiAgICByZXR1cm4gdGhpc1skc3RvcmVdW3RoaXMuY29uc3RydWN0b3IuJGlkXTtcbiAgfVxuXG4gICQkY29weVZhbHVlc0Zyb20ob3B0cyA9IHt9KSB7XG4gICAgT2JqZWN0LmtleXModGhpcy5jb25zdHJ1Y3Rvci4kZmllbGRzKS5mb3JFYWNoKChmaWVsZE5hbWUpID0+IHtcbiAgICAgIGlmIChvcHRzW2ZpZWxkTmFtZV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAvLyBjb3B5IGZyb20gb3B0cyB0byB0aGUgYmVzdCBvZiBvdXIgYWJpbGl0eVxuICAgICAgICBpZiAoXG4gICAgICAgICAgKHRoaXMuY29uc3RydWN0b3IuJGZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgPT09ICdhcnJheScpIHx8XG4gICAgICAgICAgKHRoaXMuY29uc3RydWN0b3IuJGZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgPT09ICdoYXNNYW55JylcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpc1skc3RvcmVdW2ZpZWxkTmFtZV0gPSBvcHRzW2ZpZWxkTmFtZV0uY29uY2F0KCk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5jb25zdHJ1Y3Rvci4kZmllbGRzW2ZpZWxkTmFtZV0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICB0aGlzWyRzdG9yZV1bZmllbGROYW1lXSA9IE9iamVjdC5hc3NpZ24oe30sIG9wdHNbZmllbGROYW1lXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpc1skc3RvcmVdW2ZpZWxkTmFtZV0gPSBvcHRzW2ZpZWxkTmFtZV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gICRnZXQoa2V5KSB7XG4gICAgaWYgKHRoaXNbJHN0b3JlXVtrZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpc1skc3RvcmVdW2tleV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpc1skZ3VpbGRdLmdldCh0aGlzLmNvbnN0cnVjdG9yLCB0aGlzLiRpZClcbiAgICAgIC50aGVuKCh2KSA9PiB7XG4gICAgICAgIHRoaXMuJCRjb3B5VmFsdWVzRnJvbSh2KTtcbiAgICAgICAgcmV0dXJuIHRoaXNbJHN0b3JlXVtrZXldO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgJGxvYWQob3B0cyA9IHt9KSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHtzZWxmOiB0cnVlfSwgb3B0cyk7XG4gICAgaWYgKG9wdGlvbnMuc2VsZikge1xuICAgICAgdGhpcy5nZXRTZWxmKClcbiAgICAgIC50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMuJCRjb3B5VmFsdWVzRnJvbShkYXRhKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gICRzYXZlKCkge1xuICAgIHJldHVybiB0aGlzLiRzZXQoKTtcbiAgfVxuXG4gICRzZXQodXBkYXRlID0gdGhpc1skc3RvcmVdKSB7XG4gICAgdGhpcy4kJGNvcHlWYWx1ZXNGcm9tKHVwZGF0ZSk7IC8vIHRoaXMgaXMgdGhlIG9wdGltaXN0aWMgdXBkYXRlO1xuICAgIGxldCBzZXR1cFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUodXBkYXRlKTtcbiAgICBsZXQgc2tpcFRlcm1pbmFsID0gbnVsbDtcbiAgICBpZiAoKHRoaXMuJGlkID09PSB1bmRlZmluZWQpICYmICh1cGRhdGVbdGhpcy5jb25zdHJ1Y3Rvci4kaWRdID09PSB1bmRlZmluZWQpKSB7XG4gICAgICAvLyBuZWVkIHRvIGdldCBhbiBJRC5cbiAgICAgIGNvbnN0IHRlcm1pbmFscyA9IHRoaXMuY29uc3RydWN0b3IuJHN0b3JhZ2UuZmlsdGVyKChzKSA9PiBzLnRlcm1pbmFsKTtcbiAgICAgIGlmICh0ZXJtaW5hbHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHNraXBUZXJtaW5hbCA9IHRlcm1pbmFsc1swXTtcbiAgICAgICAgc2V0dXBQcm9taXNlID0gdGVybWluYWxzWzBdLndyaXRlKHRoaXMuY29uc3RydWN0b3IsIHVwZGF0ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdNb2RlbCBjYW4gb25seSBoYXZlIG9uZSB0ZXJtaW5hbCBzdG9yZScpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNldHVwUHJvbWlzZS50aGVuKCh0b1VwZGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHRoaXMuY29uc3RydWN0b3IuJHN0b3JhZ2UubWFwKChzdG9yYWdlKSA9PiB7XG4gICAgICAgIGlmIChzdG9yYWdlICE9PSBza2lwVGVybWluYWwpIHtcbiAgICAgICAgICByZXR1cm4gc3RvcmFnZS53cml0ZSh0aGlzLmNvbnN0cnVjdG9yLCB0b1VwZGF0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRvVXBkYXRlO1xuICAgICAgICB9XG4gICAgICB9KSk7XG4gICAgfSkudGhlbigodXBkYXRlcykgPT4gdXBkYXRlc1swXSk7XG4gIH1cblxuICAkYWRkKGtleSwgaXRlbSkge1xuICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yLiRmaWVsZHNba2V5XS50eXBlID09PSAnaGFzTWFueScpIHtcbiAgICAgIGxldCBpZCA9IDA7XG4gICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdudW1iZXInKSB7XG4gICAgICAgIGlkID0gaXRlbTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlkID0gaXRlbS4kaWQ7XG4gICAgICB9XG4gICAgICBpZiAoKHR5cGVvZiBpZCA9PT0gJ251bWJlcicpICYmIChpZCA+IDEpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbCh0aGlzLmNvbnN0cnVjdG9yLiRzdG9yYWdlLm1hcCgoc3RvcmFnZSkgPT4ge1xuICAgICAgICAgIHJldHVybiBzdG9yYWdlLmFkZCh0aGlzLmNvbnN0cnVjdG9yLCB0aGlzLiRpZCwga2V5LCBpdGVtKTtcbiAgICAgICAgfSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignSW52YWxpZCBpdGVtIGFkZGVkIHRvIGhhc01hbnknKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0Nhbm5vdCAkYWRkIGV4Y2VwdCB0byBoYXNNYW55IGZpZWxkJykpO1xuICAgIH1cbiAgfVxuXG4gICRyZW1vdmUoa2V5LCBpdGVtKSB7XG4gICAgaWYgKHRoaXMuY29uc3RydWN0b3IuJGZpZWxkc1trZXldLnR5cGUgPT09ICdoYXNNYW55Jykge1xuICAgICAgbGV0IGlkID0gMDtcbiAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgaWQgPSBpdGVtO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWQgPSBpdGVtLiRpZDtcbiAgICAgIH1cbiAgICAgIGlmICgodHlwZW9mIGlkID09PSAnbnVtYmVyJykgJiYgKGlkID4gMSkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHRoaXMuY29uc3RydWN0b3IuJHN0b3JhZ2UubWFwKChzdG9yYWdlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHN0b3JhZ2UucmVtb3ZlKHRoaXMuY29uc3RydWN0b3IsIHRoaXMuJGlkLCBrZXksIGl0ZW0pO1xuICAgICAgICB9KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdJbnZhbGlkIGl0ZW0gJHJlbW92ZWQgZnJvbSBoYXNNYW55JykpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdDYW5ub3QgJHJlbW92ZSBleGNlcHQgZnJvbSBoYXNNYW55IGZpZWxkJykpO1xuICAgIH1cbiAgfVxuXG4gICRoYXMoa2V5KSB7XG4gICAgaWYgKHRoaXMuY29uc3RydWN0b3IuJGZpZWxkc1trZXldLnR5cGUgPT09ICdoYXNNYW55Jykge1xuICAgICAgcmV0dXJuIHRoaXNbJGd1aWxkXS5oYXModGhpcy5jb25zdHJ1Y3RvciwgdGhpcy4kaWQsIGtleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0Nhbm5vdCAkaGFzIG9ubHkgdmFsaWQgb24gaGFzTWFueSBmaWVsZCcpKTtcbiAgICB9XG4gIH1cblxuICAkdGVhcmRvd24oKSB7XG4gICAgdGhpc1skdW5zdWJzY3JpYmVdLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxufVxuXG5Nb2RlbC4kaWQgPSAnaWQnO1xuTW9kZWwuJG5hbWUgPSAnQmFzZSc7XG5Nb2RlbC4kc2VsZiA9ICRzZWxmO1xuTW9kZWwuJGZpZWxkcyA9IHtcbiAgaWQ6IHtcbiAgICB0eXBlOiAnbnVtYmVyJyxcbiAgfSxcbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
