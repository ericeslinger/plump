"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mergeOptions = require("merge-options");
var deepEqual = require("deep-equal");
var rxjs_1 = require("rxjs");
var plump_1 = require("./plump");
var errors_1 = require("./errors");
function condMerge(arg) {
    return mergeOptions.apply(void 0, arg.filter(function (v) { return !!v; }));
}
var Model = (function () {
    function Model(opts, plump) {
        this.plump = plump;
        this._write$ = new rxjs_1.Subject();
        this.error = null;
        if (this.type === 'BASE') {
            throw new TypeError('Cannot instantiate base plump Models, please subclass with a schema and valid type');
        }
        this.dirty = {
            attributes: {},
            relationships: {},
        };
        this.$$copyValuesFrom(opts);
    }
    Object.defineProperty(Model.prototype, "type", {
        get: function () {
            return this.constructor['type'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Model.prototype, "schema", {
        get: function () {
            return this.constructor['schema'];
        },
        enumerable: true,
        configurable: true
    });
    Model.empty = function (id) {
        var _this = this;
        var retVal = {
            id: id,
            type: this.type,
            attributes: {},
            relationships: {},
        };
        Object.keys(this.schema.attributes).forEach(function (key) {
            if (_this.schema.attributes[key].type === 'number') {
                retVal.attributes[key] = _this.schema.attributes[key].default || 0;
            }
            else if (_this.schema.attributes[key].type === 'date') {
                retVal.attributes[key] = new Date(_this.schema.attributes[key].default || Date.now());
            }
            else if (_this.schema.attributes[key].type === 'string') {
                retVal.attributes[key] = _this.schema.attributes[key].default || '';
            }
            else if (_this.schema.attributes[key].type === 'object') {
                retVal.attributes[key] = Object.assign({}, _this.schema.attributes[key].default);
            }
            else if (_this.schema.attributes[key].type === 'array') {
                retVal.attributes[key] = (_this.schema.attributes[key]
                    .default || []).concat();
            }
        });
        Object.keys(this.schema.relationships).forEach(function (key) {
            retVal.relationships[key] = [];
        });
        return retVal;
    };
    Model.prototype.empty = function (id) {
        return this.constructor['empty'](id);
    };
    Model.prototype.dirtyFields = function () {
        var _this = this;
        return Object.keys(this.dirty.attributes)
            .filter(function (k) { return k !== _this.schema.idAttribute; })
            .concat(Object.keys(this.dirty.relationships));
    };
    Model.prototype.$$copyValuesFrom = function (opts) {
        if (opts === void 0) { opts = {}; }
        if (this.id === undefined && opts[this.schema.idAttribute]) {
            if (this.schema.attributes[this.schema.idAttribute].type === 'number') {
                this.id = parseInt(opts[this.schema.idAttribute], 10);
            }
            else {
                this.id = opts[this.schema.idAttribute];
            }
        }
        this.dirty = mergeOptions(this.dirty, { attributes: opts });
    };
    Model.prototype.$$resetDirty = function () {
        this.dirty = {
            attributes: {},
            relationships: {},
        };
        this.$$fireUpdate();
    };
    Model.prototype.$$fireUpdate = function (force) {
        if (force === void 0) { force = false; }
        if (!this.id || force) {
            this._write$.next({
                attributes: this.dirty.attributes,
                type: this.type,
            });
        }
    };
    Model.prototype.get = function (opts) {
        var _this = this;
        if (opts === void 0) { opts = 'attributes'; }
        var keys = opts && !Array.isArray(opts) ? [opts] : opts;
        return this.plump
            .get(this, keys)
            .catch(function (e) {
            _this.error = e;
            return null;
        })
            .then(function (self) {
            if (!self && _this.dirtyFields().length === 0) {
                if (_this.id) {
                    _this.error = new errors_1.NotFoundError();
                }
                return null;
            }
            else if (_this.dirtyFields().length === 0) {
                return self;
            }
            else {
                var resolved = Model.resolveAndOverlay(_this.dirty, self || undefined);
                return mergeOptions({}, self || { id: _this.id, type: _this.type }, resolved);
            }
        });
    };
    Model.prototype.bulkGet = function () {
        return this.plump.bulkGet(this);
    };
    Model.prototype.save = function () {
        var _this = this;
        var update = mergeOptions({ id: this.id, type: this.type }, this.dirty);
        return this.plump
            .save(update)
            .then(function (updated) {
            _this.$$resetDirty();
            if (updated.id) {
                _this.id = updated.id;
            }
            return _this.get();
        })
            .catch(function (err) {
            throw err;
        });
    };
    Model.prototype.set = function (update) {
        var _this = this;
        var flat = update.attributes || update;
        var sanitized = Object.keys(flat)
            .filter(function (k) { return k in _this.schema.attributes; })
            .map(function (k) {
            return _a = {}, _a[k] = flat[k], _a;
            var _a;
        })
            .reduce(function (acc, curr) { return mergeOptions(acc, curr); }, {});
        this.$$copyValuesFrom(sanitized);
        this.$$fireUpdate();
        return this;
    };
    Model.prototype.asObservable = function (opts) {
        var _this = this;
        if (opts === void 0) { opts = ['relationships', 'attributes']; }
        var fields = Array.isArray(opts) ? opts.concat() : [opts];
        if (fields.indexOf('relationships') >= 0) {
            fields.splice(fields.indexOf('relationships'), 1);
            fields = fields.concat(Object.keys(this.schema.relationships).map(function (k) { return "relationships." + k; }));
        }
        var hots = this.plump.caches.filter(function (s) { return s.hot(_this); });
        var colds = this.plump.caches.filter(function (s) { return !s.hot(_this); });
        var terminal = this.plump.terminal;
        var preload$ = rxjs_1.Observable.from(hots)
            .flatMap(function (s) { return rxjs_1.Observable.fromPromise(s.read(_this, fields)); })
            .defaultIfEmpty(null)
            .flatMap(function (v) {
            if (v !== null && fields.every(function (f) { return plump_1.pathExists(v, f); })) {
                return rxjs_1.Observable.of(v);
            }
            else {
                var terminal$ = rxjs_1.Observable.fromPromise(terminal.read(_this, fields).then(function (terminalValue) {
                    if (terminalValue === null) {
                        throw new errors_1.NotFoundError();
                    }
                    else {
                        return terminalValue;
                    }
                }));
                var cold$ = rxjs_1.Observable.from(colds).flatMap(function (s) {
                    return rxjs_1.Observable.fromPromise(s.read(_this, fields));
                });
                return rxjs_1.Observable.merge(terminal$, cold$.takeUntil(terminal$));
            }
        });
        var watchWrite$ = terminal.write$
            .filter(function (v) {
            return (v.type === _this.type && v.id === _this.id);
        })
            .flatMapTo(rxjs_1.Observable.of(terminal).flatMap(function (s) {
            return rxjs_1.Observable.fromPromise(s.read(_this, fields, true));
        }))
            .startWith(null);
        return rxjs_1.Observable.combineLatest(rxjs_1.Observable.of(this.empty(this.id)), preload$, watchWrite$, this._write$.asObservable().startWith(null))
            .map(function (a) { return condMerge(a); })
            .map(function (v) {
            v.relationships = Model.resolveRelationships(_this.dirty.relationships, v.relationships);
            return v;
        })
            .distinctUntilChanged(deepEqual);
    };
    Model.prototype.delete = function () {
        return this.plump.delete(this);
    };
    Model.prototype.add = function (key, item) {
        var toAdd = Object.assign({}, { type: this.schema.relationships[key].type.sides[key].otherType }, item);
        if (key in this.schema.relationships) {
            if (item.id >= 1) {
                if (this.dirty.relationships[key] === undefined) {
                    this.dirty.relationships[key] = [];
                }
                this.dirty.relationships[key].push({
                    op: 'add',
                    data: toAdd,
                });
                this.$$fireUpdate(true);
                return this;
            }
            else {
                throw new Error('Invalid item added to hasMany');
            }
        }
        else {
            throw new Error('Cannot $add except to hasMany field');
        }
    };
    Model.prototype.modifyRelationship = function (key, item) {
        var toAdd = Object.assign({}, { type: this.schema.relationships[key].type.sides[key].otherType }, item);
        if (key in this.schema.relationships) {
            if (item.id >= 1) {
                this.dirty.relationships[key] = this.dirty.relationships[key] || [];
                this.dirty.relationships[key].push({
                    op: 'modify',
                    data: toAdd,
                });
                this.$$fireUpdate(true);
                return this;
            }
            else {
                throw new Error('Invalid item added to hasMany');
            }
        }
        else {
            throw new Error('Cannot $add except to hasMany field');
        }
    };
    Model.prototype.remove = function (key, item) {
        var toAdd = Object.assign({}, { type: this.schema.relationships[key].type.sides[key].otherType }, item);
        if (key in this.schema.relationships) {
            if (item.id >= 1) {
                if (!(key in this.dirty.relationships)) {
                    this.dirty.relationships[key] = [];
                }
                this.dirty.relationships[key].push({
                    op: 'remove',
                    data: toAdd,
                });
                this.$$fireUpdate(true);
                return this;
            }
            else {
                throw new Error('Invalid item $removed from hasMany');
            }
        }
        else {
            throw new Error('Cannot $remove except from hasMany field');
        }
    };
    Model.applyDelta = function (current, delta) {
        if (delta.op === 'add' || delta.op === 'modify') {
            var retVal = mergeOptions({}, current, delta.data);
            return retVal;
        }
        else if (delta.op === 'remove') {
            return undefined;
        }
        else {
            return current;
        }
    };
    Model.resolveAndOverlay = function (update, base) {
        if (base === void 0) { base = {
            attributes: {},
            relationships: {},
        }; }
        var attributes = mergeOptions({}, base.attributes, update.attributes);
        var resolvedRelationships = this.resolveRelationships(update.relationships, base.relationships);
        return { attributes: attributes, relationships: resolvedRelationships };
    };
    Model.resolveRelationships = function (deltas, base) {
        var _this = this;
        if (base === void 0) { base = {}; }
        var updates = Object.keys(deltas)
            .map(function (relName) {
            var resolved = _this.resolveRelationship(deltas[relName], base[relName]);
            return _a = {}, _a[relName] = resolved, _a;
            var _a;
        })
            .reduce(function (acc, curr) { return mergeOptions(acc, curr); }, {});
        return mergeOptions({}, base, updates);
    };
    Model.resolveRelationship = function (deltas, base) {
        if (base === void 0) { base = []; }
        var retVal = base.concat();
        deltas.forEach(function (delta) {
            if (delta.op === 'add' || delta.op === 'modify') {
                var currentIndex = retVal.findIndex(function (v) { return v.id === delta.data.id; });
                if (currentIndex >= 0) {
                    retVal[currentIndex] = delta.data;
                }
                else {
                    retVal.push(delta.data);
                }
            }
            else if (delta.op === 'remove') {
                var currentIndex = retVal.findIndex(function (v) { return v.id === delta.data.id; });
                if (currentIndex >= 0) {
                    retVal.splice(currentIndex, 1);
                }
            }
        });
        return retVal;
    };
    Model.type = 'BASE';
    Model.schema = {
        idAttribute: 'id',
        name: 'BASE',
        attributes: {},
        relationships: {},
    };
    return Model;
}());
exports.Model = Model;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQTFZTSxVQUFJLEdBQUcsTUFBTSxDQUFDO0lBQ2QsWUFBTSxHQUFnQjtRQUMzQixXQUFXLEVBQUUsSUFBSTtRQUNqQixJQUFJLEVBQUUsTUFBTTtRQUNaLFVBQVUsRUFBRSxFQUFFO1FBQ2QsYUFBYSxFQUFFLEVBQUU7S0FDbEIsQ0FBQztJQXFZSixZQUFDO0NBN1lELEFBNllDLElBQUE7QUE3WVksc0JBQUsiLCJmaWxlIjoibW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtZXJnZU9wdGlvbnMgZnJvbSAnbWVyZ2Utb3B0aW9ucyc7XG5pbXBvcnQgKiBhcyBkZWVwRXF1YWwgZnJvbSAnZGVlcC1lcXVhbCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIE9ic2VydmVyLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIE1vZGVsRGF0YSxcbiAgTW9kZWxEZWx0YSxcbiAgTW9kZWxTY2hlbWEsXG4gIERpcnR5VmFsdWVzLFxuICBEaXJ0eU1vZGVsLFxuICBVbnR5cGVkUmVsYXRpb25zaGlwSXRlbSxcbiAgVHlwZWRSZWxhdGlvbnNoaXBJdGVtLFxuICBSZWxhdGlvbnNoaXBEZWx0YSxcbiAgQ2FjaGVTdG9yZSxcbiAgU3RyaW5nSW5kZXhlZCxcbiAgVGVybWluYWxTdG9yZSxcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuXG5pbXBvcnQgeyBQbHVtcCwgcGF0aEV4aXN0cyB9IGZyb20gJy4vcGx1bXAnO1xuaW1wb3J0IHsgUGx1bXBFcnJvciwgTm90Rm91bmRFcnJvciB9IGZyb20gJy4vZXJyb3JzJztcblxuLy8gVE9ETzogZmlndXJlIG91dCB3aGVyZSBlcnJvciBldmVudHMgb3JpZ2luYXRlIChzdG9yYWdlIG9yIG1vZGVsKVxuLy8gYW5kIHdobyBrZWVwcyBhIHJvbGwtYmFja2FibGUgZGVsdGFcblxuZnVuY3Rpb24gY29uZE1lcmdlKGFyZzogYW55W10pIHtcbiAgcmV0dXJuIG1lcmdlT3B0aW9ucyguLi5hcmcuZmlsdGVyKHYgPT4gISF2KSk7XG59XG5cbmV4cG9ydCBjbGFzcyBNb2RlbDxNRCBleHRlbmRzIE1vZGVsRGF0YT4ge1xuICBpZDogc3RyaW5nIHwgbnVtYmVyO1xuICBzdGF0aWMgdHlwZSA9ICdCQVNFJztcbiAgc3RhdGljIHNjaGVtYTogTW9kZWxTY2hlbWEgPSB7XG4gICAgaWRBdHRyaWJ1dGU6ICdpZCcsXG4gICAgbmFtZTogJ0JBU0UnLFxuICAgIGF0dHJpYnV0ZXM6IHt9LFxuICAgIHJlbGF0aW9uc2hpcHM6IHt9LFxuICB9O1xuXG4gIHB1YmxpYyBlcnJvcjogUGx1bXBFcnJvcjtcblxuICBwdWJsaWMgX3dyaXRlJDogU3ViamVjdDxNRD4gPSBuZXcgU3ViamVjdDxNRD4oKTtcbiAgcHVibGljIGRpcnR5OiBEaXJ0eVZhbHVlcztcblxuICBnZXQgdHlwZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RvclsndHlwZSddO1xuICB9XG5cbiAgZ2V0IHNjaGVtYSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvclsnc2NoZW1hJ107XG4gIH1cblxuICBzdGF0aWMgZW1wdHkoaWQ6IG51bWJlciB8IHN0cmluZykge1xuICAgIGNvbnN0IHJldFZhbCA9IHtcbiAgICAgIGlkOiBpZCxcbiAgICAgIHR5cGU6IHRoaXMudHlwZSxcbiAgICAgIGF0dHJpYnV0ZXM6IHt9LFxuICAgICAgcmVsYXRpb25zaGlwczoge30sXG4gICAgfTtcbiAgICBPYmplY3Qua2V5cyh0aGlzLnNjaGVtYS5hdHRyaWJ1dGVzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAodGhpcy5zY2hlbWEuYXR0cmlidXRlc1trZXldLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHJldFZhbC5hdHRyaWJ1dGVzW2tleV0gPSB0aGlzLnNjaGVtYS5hdHRyaWJ1dGVzW2tleV0uZGVmYXVsdCB8fCAwO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVtYS5hdHRyaWJ1dGVzW2tleV0udHlwZSA9PT0gJ2RhdGUnKSB7XG4gICAgICAgIHJldFZhbC5hdHRyaWJ1dGVzW2tleV0gPSBuZXcgRGF0ZShcbiAgICAgICAgICAodGhpcy5zY2hlbWEuYXR0cmlidXRlc1trZXldLmRlZmF1bHQgYXMgYW55KSB8fCBEYXRlLm5vdygpLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVtYS5hdHRyaWJ1dGVzW2tleV0udHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0VmFsLmF0dHJpYnV0ZXNba2V5XSA9IHRoaXMuc2NoZW1hLmF0dHJpYnV0ZXNba2V5XS5kZWZhdWx0IHx8ICcnO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVtYS5hdHRyaWJ1dGVzW2tleV0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgcmV0VmFsLmF0dHJpYnV0ZXNba2V5XSA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgICAge30sXG4gICAgICAgICAgdGhpcy5zY2hlbWEuYXR0cmlidXRlc1trZXldLmRlZmF1bHQsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2NoZW1hLmF0dHJpYnV0ZXNba2V5XS50eXBlID09PSAnYXJyYXknKSB7XG4gICAgICAgIHJldFZhbC5hdHRyaWJ1dGVzW2tleV0gPSAoKHRoaXMuc2NoZW1hLmF0dHJpYnV0ZXNba2V5XVxuICAgICAgICAgIC5kZWZhdWx0IGFzIGFueVtdKSB8fCBbXVxuICAgICAgICApLmNvbmNhdCgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIE9iamVjdC5rZXlzKHRoaXMuc2NoZW1hLnJlbGF0aW9uc2hpcHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIHJldFZhbC5yZWxhdGlvbnNoaXBzW2tleV0gPSBbXTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmV0VmFsO1xuICB9XG5cbiAgZW1wdHkoaWQ6IG51bWJlciB8IHN0cmluZyk6IE1EIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RvclsnZW1wdHknXShpZCk7XG4gIH1cblxuICBkaXJ0eUZpZWxkcygpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5kaXJ0eS5hdHRyaWJ1dGVzKVxuICAgICAgLmZpbHRlcihrID0+IGsgIT09IHRoaXMuc2NoZW1hLmlkQXR0cmlidXRlKVxuICAgICAgLmNvbmNhdChPYmplY3Qua2V5cyh0aGlzLmRpcnR5LnJlbGF0aW9uc2hpcHMpKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKG9wdHMsIHB1YmxpYyBwbHVtcDogUGx1bXApIHtcbiAgICAvLyBUT0RPOiBEZWZpbmUgRGVsdGEgaW50ZXJmYWNlXG4gICAgdGhpcy5lcnJvciA9IG51bGw7XG4gICAgaWYgKHRoaXMudHlwZSA9PT0gJ0JBU0UnKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICAnQ2Fubm90IGluc3RhbnRpYXRlIGJhc2UgcGx1bXAgTW9kZWxzLCBwbGVhc2Ugc3ViY2xhc3Mgd2l0aCBhIHNjaGVtYSBhbmQgdmFsaWQgdHlwZScsXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuZGlydHkgPSB7XG4gICAgICBhdHRyaWJ1dGVzOiB7fSwgLy8gU2ltcGxlIGtleS12YWx1ZVxuICAgICAgcmVsYXRpb25zaGlwczoge30sIC8vIHJlbE5hbWU6IERlbHRhW11cbiAgICB9O1xuICAgIHRoaXMuJCRjb3B5VmFsdWVzRnJvbShvcHRzKTtcbiAgICAvLyB0aGlzLiQkZmlyZVVwZGF0ZShvcHRzKTtcbiAgfVxuXG4gICQkY29weVZhbHVlc0Zyb20ob3B0cyA9IHt9KTogdm9pZCB7XG4gICAgLy8gY29uc3QgaWRGaWVsZCA9IHRoaXMuY29uc3RydWN0b3IuJGlkIGluIG9wdHMgPyB0aGlzLmNvbnN0cnVjdG9yLiRpZCA6ICdpZCc7XG4gICAgLy8gdGhpc1t0aGlzLmNvbnN0cnVjdG9yLiRpZF0gPSBvcHRzW2lkRmllbGRdIHx8IHRoaXMuaWQ7XG4gICAgaWYgKHRoaXMuaWQgPT09IHVuZGVmaW5lZCAmJiBvcHRzW3RoaXMuc2NoZW1hLmlkQXR0cmlidXRlXSkge1xuICAgICAgaWYgKHRoaXMuc2NoZW1hLmF0dHJpYnV0ZXNbdGhpcy5zY2hlbWEuaWRBdHRyaWJ1dGVdLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHRoaXMuaWQgPSBwYXJzZUludChvcHRzW3RoaXMuc2NoZW1hLmlkQXR0cmlidXRlXSwgMTApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5pZCA9IG9wdHNbdGhpcy5zY2hlbWEuaWRBdHRyaWJ1dGVdO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRpcnR5ID0gbWVyZ2VPcHRpb25zKHRoaXMuZGlydHksIHsgYXR0cmlidXRlczogb3B0cyB9KTtcbiAgfVxuXG4gICQkcmVzZXREaXJ0eSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpcnR5ID0ge1xuICAgICAgYXR0cmlidXRlczoge30sIC8vIFNpbXBsZSBrZXktdmFsdWVcbiAgICAgIHJlbGF0aW9uc2hpcHM6IHt9LCAvLyByZWxOYW1lOiBEZWx0YVtdXG4gICAgfTtcbiAgICB0aGlzLiQkZmlyZVVwZGF0ZSgpO1xuICB9XG5cbiAgJCRmaXJlVXBkYXRlKGZvcmNlOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBpZiAoIXRoaXMuaWQgfHwgZm9yY2UpIHtcbiAgICAgIHRoaXMuX3dyaXRlJC5uZXh0KHtcbiAgICAgICAgYXR0cmlidXRlczogdGhpcy5kaXJ0eS5hdHRyaWJ1dGVzLFxuICAgICAgICB0eXBlOiB0aGlzLnR5cGUsXG4gICAgICB9IGFzIE1EKTtcbiAgICB9XG4gIH1cblxuICBnZXQ8VCBleHRlbmRzIE1vZGVsRGF0YT4ob3B0czogc3RyaW5nIHwgc3RyaW5nW10gPSAnYXR0cmlidXRlcycpOiBQcm9taXNlPFQ+IHtcbiAgICAvLyBJZiBvcHRzIGlzIGZhbHN5IChpLmUuLCB1bmRlZmluZWQpLCBnZXQgYXR0cmlidXRlc1xuICAgIC8vIE90aGVyd2lzZSwgZ2V0IHdoYXQgd2FzIHJlcXVlc3RlZCxcbiAgICAvLyB3cmFwcGluZyB0aGUgcmVxdWVzdCBpbiBhIEFycmF5IGlmIGl0IHdhc24ndCBhbHJlYWR5IG9uZVxuICAgIGNvbnN0IGtleXMgPSBvcHRzICYmICFBcnJheS5pc0FycmF5KG9wdHMpID8gW29wdHNdIDogb3B0cyBhcyBzdHJpbmdbXTtcbiAgICByZXR1cm4gdGhpcy5wbHVtcFxuICAgICAgLmdldCh0aGlzLCBrZXlzKVxuICAgICAgLmNhdGNoKChlOiBQbHVtcEVycm9yKSA9PiB7XG4gICAgICAgIHRoaXMuZXJyb3IgPSBlO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH0pXG4gICAgICAudGhlbjxUPihzZWxmID0+IHtcbiAgICAgICAgaWYgKCFzZWxmICYmIHRoaXMuZGlydHlGaWVsZHMoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBpZiAodGhpcy5pZCkge1xuICAgICAgICAgICAgdGhpcy5lcnJvciA9IG5ldyBOb3RGb3VuZEVycm9yKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGlydHlGaWVsZHMoKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gc2VsZjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCByZXNvbHZlZCA9IE1vZGVsLnJlc29sdmVBbmRPdmVybGF5KFxuICAgICAgICAgICAgdGhpcy5kaXJ0eSxcbiAgICAgICAgICAgIHNlbGYgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG1lcmdlT3B0aW9ucyhcbiAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgc2VsZiB8fCB7IGlkOiB0aGlzLmlkLCB0eXBlOiB0aGlzLnR5cGUgfSxcbiAgICAgICAgICAgIHJlc29sdmVkLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgYnVsa0dldDxUIGV4dGVuZHMgTW9kZWxEYXRhPigpOiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5wbHVtcC5idWxrR2V0KHRoaXMpIGFzIFByb21pc2U8VD47XG4gIH1cblxuICAvLyBUT0RPOiBTaG91bGQgJHNhdmUgdWx0aW1hdGVseSByZXR1cm4gdGhpcy5nZXQoKT9cbiAgc2F2ZTxUIGV4dGVuZHMgTW9kZWxEYXRhPigpOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCB1cGRhdGU6IERpcnR5TW9kZWwgPSBtZXJnZU9wdGlvbnMoXG4gICAgICB7IGlkOiB0aGlzLmlkLCB0eXBlOiB0aGlzLnR5cGUgfSxcbiAgICAgIHRoaXMuZGlydHksXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5wbHVtcFxuICAgICAgLnNhdmUodXBkYXRlKVxuICAgICAgLnRoZW48VD4odXBkYXRlZCA9PiB7XG4gICAgICAgIHRoaXMuJCRyZXNldERpcnR5KCk7XG4gICAgICAgIGlmICh1cGRhdGVkLmlkKSB7XG4gICAgICAgICAgdGhpcy5pZCA9IHVwZGF0ZWQuaWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH0pO1xuICB9XG5cbiAgc2V0KHVwZGF0ZSk6IHRoaXMge1xuICAgIGNvbnN0IGZsYXQgPSB1cGRhdGUuYXR0cmlidXRlcyB8fCB1cGRhdGU7XG4gICAgLy8gRmlsdGVyIG91dCBub24tYXR0cmlidXRlIGtleXNcbiAgICBjb25zdCBzYW5pdGl6ZWQgPSBPYmplY3Qua2V5cyhmbGF0KVxuICAgICAgLmZpbHRlcihrID0+IGsgaW4gdGhpcy5zY2hlbWEuYXR0cmlidXRlcylcbiAgICAgIC5tYXAoayA9PiB7XG4gICAgICAgIHJldHVybiB7IFtrXTogZmxhdFtrXSB9O1xuICAgICAgfSlcbiAgICAgIC5yZWR1Y2UoKGFjYywgY3VycikgPT4gbWVyZ2VPcHRpb25zKGFjYywgY3VyciksIHt9KTtcblxuICAgIHRoaXMuJCRjb3B5VmFsdWVzRnJvbShzYW5pdGl6ZWQpO1xuICAgIHRoaXMuJCRmaXJlVXBkYXRlKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhc09ic2VydmFibGUoXG4gICAgb3B0czogc3RyaW5nIHwgc3RyaW5nW10gPSBbJ3JlbGF0aW9uc2hpcHMnLCAnYXR0cmlidXRlcyddLFxuICApOiBPYnNlcnZhYmxlPE1EPiB7XG4gICAgbGV0IGZpZWxkcyA9IEFycmF5LmlzQXJyYXkob3B0cykgPyBvcHRzLmNvbmNhdCgpIDogW29wdHNdO1xuICAgIGlmIChmaWVsZHMuaW5kZXhPZigncmVsYXRpb25zaGlwcycpID49IDApIHtcbiAgICAgIGZpZWxkcy5zcGxpY2UoZmllbGRzLmluZGV4T2YoJ3JlbGF0aW9uc2hpcHMnKSwgMSk7XG4gICAgICBmaWVsZHMgPSBmaWVsZHMuY29uY2F0KFxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLnNjaGVtYS5yZWxhdGlvbnNoaXBzKS5tYXAoayA9PiBgcmVsYXRpb25zaGlwcy4ke2t9YCksXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGhvdHMgPSB0aGlzLnBsdW1wLmNhY2hlcy5maWx0ZXIocyA9PiBzLmhvdCh0aGlzKSk7XG4gICAgY29uc3QgY29sZHMgPSB0aGlzLnBsdW1wLmNhY2hlcy5maWx0ZXIocyA9PiAhcy5ob3QodGhpcykpO1xuICAgIGNvbnN0IHRlcm1pbmFsID0gdGhpcy5wbHVtcC50ZXJtaW5hbDtcblxuICAgIGNvbnN0IHByZWxvYWQkOiBPYnNlcnZhYmxlPE1vZGVsRGF0YT4gPSBPYnNlcnZhYmxlLmZyb20oaG90cylcbiAgICAgIC5mbGF0TWFwKChzOiBDYWNoZVN0b3JlKSA9PiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHMucmVhZCh0aGlzLCBmaWVsZHMpKSlcbiAgICAgIC5kZWZhdWx0SWZFbXB0eShudWxsKVxuICAgICAgLmZsYXRNYXAodiA9PiB7XG4gICAgICAgIGlmICh2ICE9PSBudWxsICYmIGZpZWxkcy5ldmVyeShmID0+IHBhdGhFeGlzdHModiwgZikpKSB7XG4gICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2Yodik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgdGVybWluYWwkID0gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShcbiAgICAgICAgICAgIHRlcm1pbmFsLnJlYWQodGhpcywgZmllbGRzKS50aGVuKHRlcm1pbmFsVmFsdWUgPT4ge1xuICAgICAgICAgICAgICBpZiAodGVybWluYWxWYWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRlcm1pbmFsVmFsdWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgY29sZCQgPSBPYnNlcnZhYmxlLmZyb20oY29sZHMpLmZsYXRNYXAoKHM6IENhY2hlU3RvcmUpID0+XG4gICAgICAgICAgICBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHMucmVhZCh0aGlzLCBmaWVsZHMpKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIC8vIC5zdGFydFdpdGgodW5kZWZpbmVkKTtcbiAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5tZXJnZShcbiAgICAgICAgICAgIHRlcm1pbmFsJCxcbiAgICAgICAgICAgIGNvbGQkLnRha2VVbnRpbCh0ZXJtaW5hbCQpLFxuICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTxNb2RlbERhdGE+O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICBjb25zdCB3YXRjaFdyaXRlJDogT2JzZXJ2YWJsZTxNb2RlbERhdGE+ID0gdGVybWluYWwud3JpdGUkXG4gICAgICAuZmlsdGVyKCh2OiBNb2RlbERlbHRhKSA9PiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgdi50eXBlID09PSB0aGlzLnR5cGUgJiYgdi5pZCA9PT0gdGhpcy5pZCAvLyAmJiB2LmludmFsaWRhdGUuc29tZShpID0+IGZpZWxkcy5pbmRleE9mKGkpID49IDApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICAgLmZsYXRNYXBUbyhcbiAgICAgICAgT2JzZXJ2YWJsZS5vZih0ZXJtaW5hbCkuZmxhdE1hcCgoczogVGVybWluYWxTdG9yZSkgPT5cbiAgICAgICAgICBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHMucmVhZCh0aGlzLCBmaWVsZHMsIHRydWUpKSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5zdGFydFdpdGgobnVsbCk7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY29tYmluZUxhdGVzdChcbiAgICAgIE9ic2VydmFibGUub2YodGhpcy5lbXB0eSh0aGlzLmlkKSksXG4gICAgICBwcmVsb2FkJCxcbiAgICAgIHdhdGNoV3JpdGUkLFxuICAgICAgdGhpcy5fd3JpdGUkLmFzT2JzZXJ2YWJsZSgpLnN0YXJ0V2l0aChudWxsKSBhcyBPYnNlcnZhYmxlPE1vZGVsRGF0YT4sXG4gICAgKVxuICAgICAgLm1hcCgoYTogTW9kZWxEYXRhW10pID0+IGNvbmRNZXJnZShhKSlcbiAgICAgIC5tYXAoKHY6IE1vZGVsRGF0YSkgPT4ge1xuICAgICAgICB2LnJlbGF0aW9uc2hpcHMgPSBNb2RlbC5yZXNvbHZlUmVsYXRpb25zaGlwcyhcbiAgICAgICAgICB0aGlzLmRpcnR5LnJlbGF0aW9uc2hpcHMsXG4gICAgICAgICAgdi5yZWxhdGlvbnNoaXBzLFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gdjtcbiAgICAgIH0pXG4gICAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoZGVlcEVxdWFsKSBhcyBPYnNlcnZhYmxlPE1EPjtcbiAgfVxuXG4gIGRlbGV0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5wbHVtcC5kZWxldGUodGhpcyk7XG4gIH1cblxuICBhZGQoa2V5OiBzdHJpbmcsIGl0ZW06IFVudHlwZWRSZWxhdGlvbnNoaXBJdGVtKTogdGhpcyB7XG4gICAgY29uc3QgdG9BZGQ6IFR5cGVkUmVsYXRpb25zaGlwSXRlbSA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIHsgdHlwZTogdGhpcy5zY2hlbWEucmVsYXRpb25zaGlwc1trZXldLnR5cGUuc2lkZXNba2V5XS5vdGhlclR5cGUgfSxcbiAgICAgIGl0ZW0sXG4gICAgKTtcbiAgICBpZiAoa2V5IGluIHRoaXMuc2NoZW1hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICAgIGlmIChpdGVtLmlkID49IDEpIHtcbiAgICAgICAgaWYgKHRoaXMuZGlydHkucmVsYXRpb25zaGlwc1trZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aGlzLmRpcnR5LnJlbGF0aW9uc2hpcHNba2V5XSA9IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5kaXJ0eS5yZWxhdGlvbnNoaXBzW2tleV0ucHVzaCh7XG4gICAgICAgICAgb3A6ICdhZGQnLFxuICAgICAgICAgIGRhdGE6IHRvQWRkLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy4kJGZpcmVVcGRhdGUodHJ1ZSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGl0ZW0gYWRkZWQgdG8gaGFzTWFueScpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCAkYWRkIGV4Y2VwdCB0byBoYXNNYW55IGZpZWxkJyk7XG4gICAgfVxuICB9XG5cbiAgbW9kaWZ5UmVsYXRpb25zaGlwKGtleTogc3RyaW5nLCBpdGVtOiBVbnR5cGVkUmVsYXRpb25zaGlwSXRlbSk6IHRoaXMge1xuICAgIGNvbnN0IHRvQWRkOiBUeXBlZFJlbGF0aW9uc2hpcEl0ZW0gPSBPYmplY3QuYXNzaWduKFxuICAgICAge30sXG4gICAgICB7IHR5cGU6IHRoaXMuc2NoZW1hLnJlbGF0aW9uc2hpcHNba2V5XS50eXBlLnNpZGVzW2tleV0ub3RoZXJUeXBlIH0sXG4gICAgICBpdGVtLFxuICAgICk7XG4gICAgaWYgKGtleSBpbiB0aGlzLnNjaGVtYS5yZWxhdGlvbnNoaXBzKSB7XG4gICAgICBpZiAoaXRlbS5pZCA+PSAxKSB7XG4gICAgICAgIHRoaXMuZGlydHkucmVsYXRpb25zaGlwc1trZXldID0gdGhpcy5kaXJ0eS5yZWxhdGlvbnNoaXBzW2tleV0gfHwgW107XG4gICAgICAgIHRoaXMuZGlydHkucmVsYXRpb25zaGlwc1trZXldLnB1c2goe1xuICAgICAgICAgIG9wOiAnbW9kaWZ5JyxcbiAgICAgICAgICBkYXRhOiB0b0FkZCxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuJCRmaXJlVXBkYXRlKHRydWUpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBpdGVtIGFkZGVkIHRvIGhhc01hbnknKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgJGFkZCBleGNlcHQgdG8gaGFzTWFueSBmaWVsZCcpO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZShrZXk6IHN0cmluZywgaXRlbTogVW50eXBlZFJlbGF0aW9uc2hpcEl0ZW0pOiB0aGlzIHtcbiAgICBjb25zdCB0b0FkZDogVHlwZWRSZWxhdGlvbnNoaXBJdGVtID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIHt9LFxuICAgICAgeyB0eXBlOiB0aGlzLnNjaGVtYS5yZWxhdGlvbnNoaXBzW2tleV0udHlwZS5zaWRlc1trZXldLm90aGVyVHlwZSB9LFxuICAgICAgaXRlbSxcbiAgICApO1xuICAgIGlmIChrZXkgaW4gdGhpcy5zY2hlbWEucmVsYXRpb25zaGlwcykge1xuICAgICAgaWYgKGl0ZW0uaWQgPj0gMSkge1xuICAgICAgICBpZiAoIShrZXkgaW4gdGhpcy5kaXJ0eS5yZWxhdGlvbnNoaXBzKSkge1xuICAgICAgICAgIHRoaXMuZGlydHkucmVsYXRpb25zaGlwc1trZXldID0gW107XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXJ0eS5yZWxhdGlvbnNoaXBzW2tleV0ucHVzaCh7XG4gICAgICAgICAgb3A6ICdyZW1vdmUnLFxuICAgICAgICAgIGRhdGE6IHRvQWRkLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy4kJGZpcmVVcGRhdGUodHJ1ZSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGl0ZW0gJHJlbW92ZWQgZnJvbSBoYXNNYW55Jyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90ICRyZW1vdmUgZXhjZXB0IGZyb20gaGFzTWFueSBmaWVsZCcpO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBhcHBseURlbHRhKGN1cnJlbnQsIGRlbHRhKSB7XG4gICAgaWYgKGRlbHRhLm9wID09PSAnYWRkJyB8fCBkZWx0YS5vcCA9PT0gJ21vZGlmeScpIHtcbiAgICAgIGNvbnN0IHJldFZhbCA9IG1lcmdlT3B0aW9ucyh7fSwgY3VycmVudCwgZGVsdGEuZGF0YSk7XG4gICAgICByZXR1cm4gcmV0VmFsO1xuICAgIH0gZWxzZSBpZiAoZGVsdGEub3AgPT09ICdyZW1vdmUnKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY3VycmVudDtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgcmVzb2x2ZUFuZE92ZXJsYXkoXG4gICAgdXBkYXRlLFxuICAgIGJhc2U6IHsgYXR0cmlidXRlcz86IGFueTsgcmVsYXRpb25zaGlwcz86IGFueSB9ID0ge1xuICAgICAgYXR0cmlidXRlczoge30sXG4gICAgICByZWxhdGlvbnNoaXBzOiB7fSxcbiAgICB9LFxuICApIHtcbiAgICBjb25zdCBhdHRyaWJ1dGVzID0gbWVyZ2VPcHRpb25zKHt9LCBiYXNlLmF0dHJpYnV0ZXMsIHVwZGF0ZS5hdHRyaWJ1dGVzKTtcbiAgICBjb25zdCByZXNvbHZlZFJlbGF0aW9uc2hpcHMgPSB0aGlzLnJlc29sdmVSZWxhdGlvbnNoaXBzKFxuICAgICAgdXBkYXRlLnJlbGF0aW9uc2hpcHMsXG4gICAgICBiYXNlLnJlbGF0aW9uc2hpcHMsXG4gICAgKTtcbiAgICByZXR1cm4geyBhdHRyaWJ1dGVzLCByZWxhdGlvbnNoaXBzOiByZXNvbHZlZFJlbGF0aW9uc2hpcHMgfTtcbiAgfVxuXG4gIHN0YXRpYyByZXNvbHZlUmVsYXRpb25zaGlwcyhcbiAgICBkZWx0YXM6IFN0cmluZ0luZGV4ZWQ8UmVsYXRpb25zaGlwRGVsdGFbXT4sXG4gICAgYmFzZTogU3RyaW5nSW5kZXhlZDxUeXBlZFJlbGF0aW9uc2hpcEl0ZW1bXT4gPSB7fSxcbiAgKSB7XG4gICAgY29uc3QgdXBkYXRlcyA9IE9iamVjdC5rZXlzKGRlbHRhcylcbiAgICAgIC5tYXAocmVsTmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkID0gdGhpcy5yZXNvbHZlUmVsYXRpb25zaGlwKFxuICAgICAgICAgIGRlbHRhc1tyZWxOYW1lXSxcbiAgICAgICAgICBiYXNlW3JlbE5hbWVdLFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4geyBbcmVsTmFtZV06IHJlc29sdmVkIH07XG4gICAgICB9KVxuICAgICAgLnJlZHVjZSgoYWNjLCBjdXJyKSA9PiBtZXJnZU9wdGlvbnMoYWNjLCBjdXJyKSwge30pO1xuICAgIHJldHVybiBtZXJnZU9wdGlvbnMoe30sIGJhc2UsIHVwZGF0ZXMpO1xuICB9XG5cbiAgc3RhdGljIHJlc29sdmVSZWxhdGlvbnNoaXAoXG4gICAgZGVsdGFzOiBSZWxhdGlvbnNoaXBEZWx0YVtdLFxuICAgIGJhc2U6IFR5cGVkUmVsYXRpb25zaGlwSXRlbVtdID0gW10sXG4gICkge1xuICAgIGNvbnN0IHJldFZhbCA9IGJhc2UuY29uY2F0KCk7XG4gICAgZGVsdGFzLmZvckVhY2goZGVsdGEgPT4ge1xuICAgICAgaWYgKGRlbHRhLm9wID09PSAnYWRkJyB8fCBkZWx0YS5vcCA9PT0gJ21vZGlmeScpIHtcbiAgICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gcmV0VmFsLmZpbmRJbmRleCh2ID0+IHYuaWQgPT09IGRlbHRhLmRhdGEuaWQpO1xuICAgICAgICBpZiAoY3VycmVudEluZGV4ID49IDApIHtcbiAgICAgICAgICByZXRWYWxbY3VycmVudEluZGV4XSA9IGRlbHRhLmRhdGE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0VmFsLnB1c2goZGVsdGEuZGF0YSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZGVsdGEub3AgPT09ICdyZW1vdmUnKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHJldFZhbC5maW5kSW5kZXgodiA9PiB2LmlkID09PSBkZWx0YS5kYXRhLmlkKTtcbiAgICAgICAgaWYgKGN1cnJlbnRJbmRleCA+PSAwKSB7XG4gICAgICAgICAgcmV0VmFsLnNwbGljZShjdXJyZW50SW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJldFZhbDtcbiAgfVxufVxuIl19
