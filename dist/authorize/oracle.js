"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Oracle = (function () {
    function Oracle(keyService) {
        this.keyService = keyService;
        this.authorizers = {};
    }
    Oracle.prototype.addAuthorizer = function (auth, forType) {
        var authKeys = Object.keys(auth.relationships);
        var forKeys = Object.keys(forType.relationships);
        var missing = forKeys.filter(function (k) { return authKeys.indexOf(k) < 0; });
        if (missing.length > 0) {
            throw new Error("Missing relationship authorizer(s) " + missing.join(', '));
        }
        this.authorizers[forType.name] = auth;
    };
    Oracle.prototype.dispatch = function (request) {
        var _this = this;
        return Promise.resolve()
            .then(function () {
            if (request.kind === 'relationship') {
                var relationshipAuthorizer = _this.authorizers[request.parent.type].relationships[request.relationship];
                if (request.action === 'create') {
                    return relationshipAuthorizer.authorizeCreate(request);
                }
                else if (request.action === 'read') {
                    return relationshipAuthorizer.authorizeRead(request);
                }
                else if (request.action === 'update') {
                    return relationshipAuthorizer.authorizeUpdate(request);
                }
                else if (request.action === 'delete') {
                    return relationshipAuthorizer.authorizeDelete(request);
                }
            }
            else if (request.kind === 'attributes') {
                if (request.action === 'create') {
                    return _this.authorizers[request.data.type].attributes.authorizeCreate(request);
                }
                else if (request.action === 'read') {
                    return _this.authorizers[request.target.type].attributes.authorizeRead(request);
                }
                else if (request.action === 'update') {
                    return _this.authorizers[request.target.type].attributes.authorizeUpdate(request);
                }
                else if (request.action === 'delete') {
                    return _this.authorizers[request.target.type].attributes.authorizeDelete(request);
                }
            }
            else if (request.kind === 'compound') {
                return Promise.all(request.list.map(function (v) { return _this.dispatch(v); }))
                    .then(function (res) { return request.combinator === 'or' ? res.some(function (v) { return v.result; }) : res.every(function (v) { return v.result; }); })
                    .then(function (f) { return ({ kind: 'final', result: f }); });
            }
        }).then(function (v) {
            if (v.kind === 'final') {
                return v;
            }
            else if (v.kind === 'delegated') {
                return _this.dispatch(v.delegate);
            }
        });
    };
    Oracle.prototype.authorize = function (request) {
        return this.dispatch(request)
            .then(function (f) { return f.result; });
    };
    return Oracle;
}());
exports.Oracle = Oracle;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hdXRob3JpemUvb3JhY2xlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBU0E7SUFHRSxnQkFBbUIsVUFBdUI7UUFBdkIsZUFBVSxHQUFWLFVBQVUsQ0FBYTtRQUZsQyxnQkFBVyxHQUEyQyxFQUFFLENBQUM7SUFFbkIsQ0FBQztJQUUvQyw4QkFBYSxHQUFiLFVBQWMsSUFBMEIsRUFBRSxPQUFvQjtRQUM1RCxJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNqRCxJQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNuRCxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQXZCLENBQXVCLENBQUMsQ0FBQztRQUM3RCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3Q0FBc0MsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUcsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDeEMsQ0FBQztJQUVELHlCQUFRLEdBQVIsVUFBUyxPQUF5QjtRQUFsQyxpQkFvQ0M7UUFuQ0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7YUFDdkIsSUFBSSxDQUFvQjtZQUN2QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQU0sc0JBQXNCLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUks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QSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxFQUFSLENBQVEsQ0FBRSxFQUFqRixDQUFpRixDQUFDO3FCQUMxSCxJQUFJLENBQXlCLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztZQUNyRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztZQUNSLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNsQyxNQUFNLENBQUMsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELDBCQUFTLEdBQVQsVUFBVSxPQUF5QjtRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7YUFDNUIsSUFBSSxDQUFDLFVBQUMsQ0FBeUIsSUFBSyxPQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNILGFBQUM7QUFBRCxDQXpEQSxBQXlEQyxJQUFBO0FBekRZLHdCQUFNIiwiZmlsZSI6ImF1dGhvcml6ZS9vcmFjbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBdXRob3JpemVyRGVmaW5pdGlvbixcbiAgQXV0aG9yaXplUmVxdWVzdCxcbiAgQXV0aG9yaXplUmVzcG9uc2UsXG4gIEZpbmFsQXV0aG9yaXplUmVzcG9uc2UsXG4gIEtleVNlcnZpY2Vcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuaW1wb3J0IHsgTW9kZWxTY2hlbWEgfSBmcm9tICcuLi9kYXRhVHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgT3JhY2xlIHtcbiAgcHJpdmF0ZSBhdXRob3JpemVyczoge1tuYW1lOiBzdHJpbmddOiBBdXRob3JpemVyRGVmaW5pdGlvbn0gPSB7fTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMga2V5U2VydmljZT86IEtleVNlcnZpY2UpIHsgfVxuXG4gIGFkZEF1dGhvcml6ZXIoYXV0aDogQXV0aG9yaXplckRlZmluaXRpb24sIGZvclR5cGU6IE1vZGVsU2NoZW1hKSB7XG4gICAgY29uc3QgYXV0aEtleXMgPSBPYmplY3Qua2V5cyhhdXRoLnJlbGF0aW9uc2hpcHMpO1xuICAgIGNvbnN0IGZvcktleXMgPSBPYmplY3Qua2V5cyhmb3JUeXBlLnJlbGF0aW9uc2hpcHMpO1xuICAgIGNvbnN0IG1pc3NpbmcgPSBmb3JLZXlzLmZpbHRlcihrID0+IGF1dGhLZXlzLmluZGV4T2YoaykgPCAwKTtcbiAgICBpZiAobWlzc2luZy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgcmVsYXRpb25zaGlwIGF1dGhvcml6ZXIocykgJHttaXNzaW5nLmpvaW4oJywgJyl9YCk7XG4gICAgfVxuICAgIHRoaXMuYXV0aG9yaXplcnNbZm9yVHlwZS5uYW1lXSA9IGF1dGg7XG4gIH1cblxuICBkaXNwYXRjaChyZXF1ZXN0OiBBdXRob3JpemVSZXF1ZXN0KTogUHJvbWlzZTxBdXRob3JpemVSZXNwb25zZT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgIC50aGVuPEF1dGhvcml6ZVJlc3BvbnNlPigoKSA9PiB7XG4gICAgICBpZiAocmVxdWVzdC5raW5kID09PSAncmVsYXRpb25zaGlwJykge1xuICAgICAgICBjb25zdCByZWxhdGlvbnNoaXBBdXRob3JpemVyID0gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LnBhcmVudC50eXBlXS5yZWxhdGlvbnNoaXBzW3JlcXVlc3QucmVsYXRpb25zaGlwXTtcbiAgICAgICAgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAnY3JlYXRlJykge1xuICAgICAgICAgIHJldHVybiByZWxhdGlvbnNoaXBBdXRob3JpemVyLmF1dGhvcml6ZUNyZWF0ZShyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ3JlYWQnKSB7XG4gICAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEF1dGhvcml6ZXIuYXV0aG9yaXplUmVhZChyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgICByZXR1cm4gcmVsYXRpb25zaGlwQXV0aG9yaXplci5hdXRob3JpemVVcGRhdGUocmVxdWVzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdkZWxldGUnKSB7XG4gICAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEF1dGhvcml6ZXIuYXV0aG9yaXplRGVsZXRlKHJlcXVlc3QpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHJlcXVlc3Qua2luZCA9PT0gJ2F0dHJpYnV0ZXMnKSB7XG4gICAgICAgIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2NyZWF0ZScpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LmRhdGEudHlwZV0uYXR0cmlidXRlcy5hdXRob3JpemVDcmVhdGUocmVxdWVzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdyZWFkJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QudGFyZ2V0LnR5cGVdLmF0dHJpYnV0ZXMuYXV0aG9yaXplUmVhZChyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LnRhcmdldC50eXBlXS5hdHRyaWJ1dGVzLmF1dGhvcml6ZVVwZGF0ZShyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2RlbGV0ZScpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LnRhcmdldC50eXBlXS5hdHRyaWJ1dGVzLmF1dGhvcml6ZURlbGV0ZShyZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmtpbmQgPT09ICdjb21wb3VuZCcpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHJlcXVlc3QubGlzdC5tYXAodiA9PiB0aGlzLmRpc3BhdGNoKHYpKSlcbiAgICAgICAgLnRoZW4oKHJlczogRmluYWxBdXRob3JpemVSZXNwb25zZVtdKSA9PiByZXF1ZXN0LmNvbWJpbmF0b3IgPT09ICdvcicgPyByZXMuc29tZSh2ID0+IHYucmVzdWx0KSA6IHJlcy5ldmVyeSh2ID0+IHYucmVzdWx0ICkpXG4gICAgICAgIC50aGVuPEZpbmFsQXV0aG9yaXplUmVzcG9uc2U+KGYgPT4gKHsga2luZDogJ2ZpbmFsJywgcmVzdWx0OiBmIH0pKTtcbiAgICAgIH1cbiAgICB9KS50aGVuKCh2KSA9PiB7XG4gICAgICBpZiAodi5raW5kID09PSAnZmluYWwnKSB7XG4gICAgICAgIHJldHVybiB2O1xuICAgICAgfSBlbHNlIGlmICh2LmtpbmQgPT09ICdkZWxlZ2F0ZWQnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoKHYuZGVsZWdhdGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgYXV0aG9yaXplKHJlcXVlc3Q6IEF1dGhvcml6ZVJlcXVlc3QpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5kaXNwYXRjaChyZXF1ZXN0KVxuICAgIC50aGVuKChmOiBGaW5hbEF1dGhvcml6ZVJlc3BvbnNlKSA9PiBmLnJlc3VsdCk7XG4gIH1cbn1cbiJdfQ==
