"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Oracle = (function () {
    function Oracle(keyService) {
        this.keyService = keyService;
        this.authorizers = {};
    }
    Oracle.prototype.addAuthorizer = function (auth, forType) {
        var authKeys = Object.keys(auth.relationships);
        var forKeys = Object.keys(forType.relationships);
        var missing = forKeys.filter(function (k) { return authKeys.indexOf(k) < 0; });
        if (missing.length > 0) {
            throw new Error("Missing relationship authorizer(s) " + missing.join(', '));
        }
        this.authorizers[forType.name] = auth;
    };
    Oracle.prototype.dispatch = function (request) {
        var _this = this;
        return Promise.resolve()
            .then(function () {
            if (request.kind === 'relationship') {
                var relationshipAuthorizer = _this.authorizers[request.parent.type].relationships[request.relationship];
                if (request.action === 'create') {
                    return relationshipAuthorizer.authorizeCreate(request);
                }
                else if (request.action === 'read') {
                    return relationshipAuthorizer.authorizeRead(request);
                }
                else if (request.action === 'update') {
                    return relationshipAuthorizer.authorizeUpdate(request);
                }
                else if (request.action === 'delete') {
                    return relationshipAuthorizer.authorizeDelete(request);
                }
            }
            else if (request.kind === 'attributes') {
                if (request.action === 'create') {
                    return _this.authorizers[request.data.type].attributes.authorizeCreate(request);
                }
                else if (request.action === 'read') {
                    return _this.authorizers[request.target.type].attributes.authorizeRead(request);
                }
                else if (request.action === 'update') {
                    return _this.authorizers[request.target.type].attributes.authorizeUpdate(request);
                }
                else if (request.action === 'delete') {
                    return _this.authorizers[request.target.type].attributes.authorizeDelete(request);
                }
            }
            else if (request.kind === 'compound') {
                return Promise.all(request.list.map(function (v) { return _this.dispatch(v); }))
                    .then(function (res) { return request.combinator === 'or' ? res.some(function (v) { return v.result; }) : res.every(function (v) { return v.result; }); })
                    .then(function (f) { return ({ kind: 'final', result: f }); });
            }
        }).then(function (v) {
            if (v.kind === 'final') {
                return v;
            }
            else if (v.kind === 'delegated') {
                return _this.dispatch(v.delegate);
            }
        });
    };
    Oracle.prototype.authorize = function (request) {
        return this.dispatch(request)
            .then(function (f) { return f.result; });
    };
    return Oracle;
}());
exports.Oracle = Oracle;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hdXRob3JpemUvb3JhY2xlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBU0E7SUFHRSxnQkFBbUIsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUZqQyxnQkFBVyxHQUEyQyxFQUFFLENBQUM7SUFFcEIsQ0FBQztJQUU5Qyw4QkFBYSxHQUFiLFVBQWMsSUFBMEIsRUFBRSxPQUFvQjtRQUM1RCxJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNqRCxJQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNuRCxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQXZCLENBQXVCLENBQUMsQ0FBQztRQUM3RCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3Q0FBc0MsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUcsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDeEMsQ0FBQztJQUVELHlCQUFRLEdBQVIsVUFBUyxPQUF5QjtRQUFsQyxpQkFvQ0M7UUFuQ0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7YUFDdkIsSUFBSSxDQUFvQjtZQUN2QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQU0sc0JBQXNCLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUks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QSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxFQUFSLENBQVEsQ0FBRSxFQUFqRixDQUFpRixDQUFDO3FCQUMxSCxJQUFJLENBQXlCLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztZQUNyRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztZQUNSLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNsQyxNQUFNLENBQUMsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELDBCQUFTLEdBQVQsVUFBVSxPQUF5QjtRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7YUFDNUIsSUFBSSxDQUFDLFVBQUMsQ0FBeUIsSUFBSyxPQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNILGFBQUM7QUFBRCxDQXpEQSxBQXlEQyxJQUFBO0FBekRZLHdCQUFNIiwiZmlsZSI6ImF1dGhvcml6ZS9vcmFjbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBdXRob3JpemVyRGVmaW5pdGlvbixcbiAgQXV0aG9yaXplUmVxdWVzdCxcbiAgQXV0aG9yaXplUmVzcG9uc2UsXG4gIEZpbmFsQXV0aG9yaXplUmVzcG9uc2UsXG4gIEtleVNlcnZpY2Vcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuaW1wb3J0IHsgTW9kZWxTY2hlbWEgfSBmcm9tICcuLi9kYXRhVHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgT3JhY2xlIHtcbiAgcHJpdmF0ZSBhdXRob3JpemVyczoge1tuYW1lOiBzdHJpbmddOiBBdXRob3JpemVyRGVmaW5pdGlvbn0gPSB7fTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMga2V5U2VydmljZTogS2V5U2VydmljZSkgeyB9XG5cbiAgYWRkQXV0aG9yaXplcihhdXRoOiBBdXRob3JpemVyRGVmaW5pdGlvbiwgZm9yVHlwZTogTW9kZWxTY2hlbWEpIHtcbiAgICBjb25zdCBhdXRoS2V5cyA9IE9iamVjdC5rZXlzKGF1dGgucmVsYXRpb25zaGlwcyk7XG4gICAgY29uc3QgZm9yS2V5cyA9IE9iamVjdC5rZXlzKGZvclR5cGUucmVsYXRpb25zaGlwcyk7XG4gICAgY29uc3QgbWlzc2luZyA9IGZvcktleXMuZmlsdGVyKGsgPT4gYXV0aEtleXMuaW5kZXhPZihrKSA8IDApO1xuICAgIGlmIChtaXNzaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyByZWxhdGlvbnNoaXAgYXV0aG9yaXplcihzKSAke21pc3Npbmcuam9pbignLCAnKX1gKTtcbiAgICB9XG4gICAgdGhpcy5hdXRob3JpemVyc1tmb3JUeXBlLm5hbWVdID0gYXV0aDtcbiAgfVxuXG4gIGRpc3BhdGNoKHJlcXVlc3Q6IEF1dGhvcml6ZVJlcXVlc3QpOiBQcm9taXNlPEF1dGhvcml6ZVJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgLnRoZW48QXV0aG9yaXplUmVzcG9uc2U+KCgpID0+IHtcbiAgICAgIGlmIChyZXF1ZXN0LmtpbmQgPT09ICdyZWxhdGlvbnNoaXAnKSB7XG4gICAgICAgIGNvbnN0IHJlbGF0aW9uc2hpcEF1dGhvcml6ZXIgPSB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QucGFyZW50LnR5cGVdLnJlbGF0aW9uc2hpcHNbcmVxdWVzdC5yZWxhdGlvbnNoaXBdO1xuICAgICAgICBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdjcmVhdGUnKSB7XG4gICAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEF1dGhvcml6ZXIuYXV0aG9yaXplQ3JlYXRlKHJlcXVlc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAncmVhZCcpIHtcbiAgICAgICAgICByZXR1cm4gcmVsYXRpb25zaGlwQXV0aG9yaXplci5hdXRob3JpemVSZWFkKHJlcXVlc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAndXBkYXRlJykge1xuICAgICAgICAgIHJldHVybiByZWxhdGlvbnNoaXBBdXRob3JpemVyLmF1dGhvcml6ZVVwZGF0ZShyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2RlbGV0ZScpIHtcbiAgICAgICAgICByZXR1cm4gcmVsYXRpb25zaGlwQXV0aG9yaXplci5hdXRob3JpemVEZWxldGUocmVxdWVzdCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5raW5kID09PSAnYXR0cmlidXRlcycpIHtcbiAgICAgICAgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAnY3JlYXRlJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QuZGF0YS50eXBlXS5hdHRyaWJ1dGVzLmF1dGhvcml6ZUNyZWF0ZShyZXF1ZXN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ3JlYWQnKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYXV0aG9yaXplcnNbcmVxdWVzdC50YXJnZXQudHlwZV0uYXR0cmlidXRlcy5hdXRob3JpemVSZWFkKHJlcXVlc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAndXBkYXRlJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QudGFyZ2V0LnR5cGVdLmF0dHJpYnV0ZXMuYXV0aG9yaXplVXBkYXRlKHJlcXVlc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAnZGVsZXRlJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QudGFyZ2V0LnR5cGVdLmF0dHJpYnV0ZXMuYXV0aG9yaXplRGVsZXRlKHJlcXVlc3QpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHJlcXVlc3Qua2luZCA9PT0gJ2NvbXBvdW5kJykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVxdWVzdC5saXN0Lm1hcCh2ID0+IHRoaXMuZGlzcGF0Y2godikpKVxuICAgICAgICAudGhlbigocmVzOiBGaW5hbEF1dGhvcml6ZVJlc3BvbnNlW10pID0+IHJlcXVlc3QuY29tYmluYXRvciA9PT0gJ29yJyA/IHJlcy5zb21lKHYgPT4gdi5yZXN1bHQpIDogcmVzLmV2ZXJ5KHYgPT4gdi5yZXN1bHQgKSlcbiAgICAgICAgLnRoZW48RmluYWxBdXRob3JpemVSZXNwb25zZT4oZiA9PiAoeyBraW5kOiAnZmluYWwnLCByZXN1bHQ6IGYgfSkpO1xuICAgICAgfVxuICAgIH0pLnRoZW4oKHYpID0+IHtcbiAgICAgIGlmICh2LmtpbmQgPT09ICdmaW5hbCcpIHtcbiAgICAgICAgcmV0dXJuIHY7XG4gICAgICB9IGVsc2UgaWYgKHYua2luZCA9PT0gJ2RlbGVnYXRlZCcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2godi5kZWxlZ2F0ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhdXRob3JpemUocmVxdWVzdDogQXV0aG9yaXplUmVxdWVzdCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmRpc3BhdGNoKHJlcXVlc3QpXG4gICAgLnRoZW4oKGY6IEZpbmFsQXV0aG9yaXplUmVzcG9uc2UpID0+IGYucmVzdWx0KTtcbiAgfVxufVxuIl19
