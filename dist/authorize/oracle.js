"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Oracle = (function () {
    function Oracle(keyService) {
        this.keyService = keyService;
        this.authorizers = {};
    }
    Oracle.prototype.addAuthorizer = function (auth, forType) {
        this.authorizers[forType] = auth;
    };
    Oracle.prototype.dispatch = function (request) {
        var _this = this;
        return Promise.resolve()
            .then(function () {
            if (request.kind === 'relationship') {
                return _this.authorizers[request.parent.type].authorize(request);
            }
            else if (request.kind === 'attributes') {
                return _this.authorizers[request.target.type].authorize(request);
            }
            else if (request.kind === 'compound') {
                return Promise.all(request.list.map(function (v) { return _this.dispatch(v); }))
                    .then(function (res) {
                    return request.combinator === 'or'
                        ? res.some(function (v) { return v.result; })
                        : res.every(function (v) { return v.result; });
                })
                    .then(function (f) { return ({ kind: 'final', result: f }); });
            }
        })
            .then(function (v) {
            if (v.kind === 'final') {
                return v;
            }
            else if (v.kind === 'delegated') {
                return _this.dispatch(v.delegate);
            }
        });
    };
    Oracle.prototype.authorize = function (request) {
        return this.dispatch(request).then(function (f) { return f.result; });
    };
    return Oracle;
}());
exports.Oracle = Oracle;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hdXRob3JpemUvb3JhY2xlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBUUE7SUFHRSxnQkFBbUIsVUFBdUI7UUFBdkIsZUFBVSxHQUFWLFVBQVUsQ0FBYTtRQUZuQyxnQkFBVyxHQUE2QyxFQUFFLENBQUM7SUFFckIsQ0FBQztJQUU5Qyw4QkFBYSxHQUFiLFVBQWMsSUFBMEIsRUFBRSxPQUFlO1FBQ3ZELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ25DLENBQUM7SUFFRCx5QkFBUSxHQUFSLFVBQVMsT0FBeUI7UUFBbEMsaUJBeUJDO1FBeEJDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO2FBQ3JCLElBQUksQ0FBb0I7WUFDdkIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxjQUFjLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLENBQUMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDekMsTUFBTSxDQUFDLEtBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEUsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO3FCQUN4RCxJQUFJLENBQ0gsVUFBQyxHQUE2QjtvQkFDNUIsT0FBQSxPQUFPLENBQUMsVUFBVSxLQUFLLElBQUk7MEJBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxFQUFSLENBQVEsQ0FBQzswQkFDdkIsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVIsQ0FBUSxDQUFDO2dCQUY1QixDQUU0QixDQUMvQjtxQkFDQSxJQUFJLENBQXlCLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztZQUN2RSxDQUFDO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLFVBQUEsQ0FBQztZQUNMLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNsQyxNQUFNLENBQUMsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDBCQUFTLEdBQVQsVUFBVSxPQUF5QjtRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUF5QixJQUFLLE9BQUEsQ0FBQyxDQUFDLE1BQU0sRUFBUixDQUFRLENBQUMsQ0FBQztJQUM5RSxDQUFDO0lBQ0gsYUFBQztBQUFELENBdkNBLEFBdUNDLElBQUE7QUF2Q1ksd0JBQU0iLCJmaWxlIjoiYXV0aG9yaXplL29yYWNsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEF1dGhvcml6ZXJEZWZpbml0aW9uLFxuICBBdXRob3JpemVSZXF1ZXN0LFxuICBBdXRob3JpemVSZXNwb25zZSxcbiAgRmluYWxBdXRob3JpemVSZXNwb25zZSxcbiAgS2V5U2VydmljZSxcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgT3JhY2xlIHtcbiAgcHVibGljIGF1dGhvcml6ZXJzOiB7IFtuYW1lOiBzdHJpbmddOiBBdXRob3JpemVyRGVmaW5pdGlvbiB9ID0ge307XG5cbiAgY29uc3RydWN0b3IocHVibGljIGtleVNlcnZpY2U/OiBLZXlTZXJ2aWNlKSB7fVxuXG4gIGFkZEF1dGhvcml6ZXIoYXV0aDogQXV0aG9yaXplckRlZmluaXRpb24sIGZvclR5cGU6IHN0cmluZykge1xuICAgIHRoaXMuYXV0aG9yaXplcnNbZm9yVHlwZV0gPSBhdXRoO1xuICB9XG5cbiAgZGlzcGF0Y2gocmVxdWVzdDogQXV0aG9yaXplUmVxdWVzdCk6IFByb21pc2U8RmluYWxBdXRob3JpemVSZXNwb25zZT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgLnRoZW48QXV0aG9yaXplUmVzcG9uc2U+KCgpID0+IHtcbiAgICAgICAgaWYgKHJlcXVlc3Qua2luZCA9PT0gJ3JlbGF0aW9uc2hpcCcpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LnBhcmVudC50eXBlXS5hdXRob3JpemUocmVxdWVzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5raW5kID09PSAnYXR0cmlidXRlcycpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hdXRob3JpemVyc1tyZXF1ZXN0LnRhcmdldC50eXBlXS5hdXRob3JpemUocmVxdWVzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5raW5kID09PSAnY29tcG91bmQnKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHJlcXVlc3QubGlzdC5tYXAodiA9PiB0aGlzLmRpc3BhdGNoKHYpKSlcbiAgICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgICAocmVzOiBGaW5hbEF1dGhvcml6ZVJlc3BvbnNlW10pID0+XG4gICAgICAgICAgICAgICAgcmVxdWVzdC5jb21iaW5hdG9yID09PSAnb3InXG4gICAgICAgICAgICAgICAgICA/IHJlcy5zb21lKHYgPT4gdi5yZXN1bHQpXG4gICAgICAgICAgICAgICAgICA6IHJlcy5ldmVyeSh2ID0+IHYucmVzdWx0KSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC50aGVuPEZpbmFsQXV0aG9yaXplUmVzcG9uc2U+KGYgPT4gKHsga2luZDogJ2ZpbmFsJywgcmVzdWx0OiBmIH0pKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKHYgPT4ge1xuICAgICAgICBpZiAodi5raW5kID09PSAnZmluYWwnKSB7XG4gICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgIH0gZWxzZSBpZiAodi5raW5kID09PSAnZGVsZWdhdGVkJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoKHYuZGVsZWdhdGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIGF1dGhvcml6ZShyZXF1ZXN0OiBBdXRob3JpemVSZXF1ZXN0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2gocmVxdWVzdCkudGhlbigoZjogRmluYWxBdXRob3JpemVSZXNwb25zZSkgPT4gZi5yZXN1bHQpO1xuICB9XG59XG4iXX0=
